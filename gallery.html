<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fresh-green': '#22c55e',
                        'dark-green': '#16a34a',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto px-4 py-12">
        <div class="w-full max-w-2xl mx-auto">
            <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-800">Upload & Manage Projects</h1>
                    <p class="text-gray-600 mt-2">Add new images or remove existing ones from the gallery.</p>
                </div>

                <form id="upload-form">
                    <div class="mb-6">
                        <label for="image-input" class="block text-sm font-medium text-gray-700 mb-2">Select an image to upload:</label>
                       <input type="file" id="image-input" name="image" accept="image/png, image/jpeg, image/gif" required multiple
                               class="w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-5 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-fresh-green/10 file:text-fresh-green hover:file:bg-fresh-green/20 cursor-pointer">
                    </div>
                    
                    <button type="submit" id="upload-btn" class="w-full bg-fresh-green text-white font-bold py-4 px-6 rounded-full transition duration-300 hover:bg-dark-green disabled:bg-gray-400 text-lg">
                        <span id="btn-text">Upload Image</span>
                        <span id="btn-loader" class="hidden">Uploading...</span>
                    </button>
                    <p id="upload-status" class="text-center text-sm mt-4 h-5"></p>
                    <a href="index.html" class="block text-center mt-4 text-sm text-gray-500 hover:text-fresh-green">← Back to Public Gallery</a>
                </form>
            </div>
        </div>

        <div class="mt-16">
            <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">Currently in Gallery</h2>
            <div id="management-gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>

    <script>
    // --- Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyCV2IrYyrDuvwo0KrDkErYU5jQzF_Ay33A",
        authDomain: "web-course-ba01f.firebaseapp.com",
        databaseURL: "https://web-course-ba01f-default-rtdb.firebaseio.com",
        projectId: "web-course-ba01f",
        storageBucket: "web-course-ba01f.appspot.com",
        messagingSenderId: "395157922720",
        appId: "1:395157922720:web:fa0377e2de141de9d03ac5",
        measurementId: "G-ZVJ6VDD0CQ"
    };
    const imgbbApiKey = '65be3e7586c166102752452ff286571a';

    // --- Firebase Initialization ---
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const imagesRef = database.ref('images');

    // --- Elements ---
    const uploadForm = document.getElementById('upload-form');
    const imageInput = document.getElementById('image-input');
    const uploadBtn = document.getElementById('upload-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoader = document.getElementById('btn-loader');
    const uploadStatus = document.getElementById('upload-status');
    const managementGallery = document.getElementById('management-gallery');

    // --- Main Submit Event Listener ---
    uploadForm.addEventListener('submit', function (event) {
        event.preventDefault();
        const files = imageInput.files;
        if (files.length === 0) {
            uploadStatus.textContent = 'කරුණාකර පළමුව රූපයක් තෝරන්න.';
            return;
        }

        // Update UI for multiple files
        uploadStatus.textContent = `Uploading ${files.length} image(s)...`;
        uploadBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');

        // Create an array of upload promises
        const uploadPromises = [];
        for (const file of files) {
            uploadPromises.push(uploadFile(file));
        }

        // Use Promise.all to wait for all uploads to complete
        Promise.all(uploadPromises)
            .then(results => {
                uploadStatus.textContent = `✅ Success! All ${results.length} images have been added to the gallery.`;
                uploadForm.reset();
            })
            .catch(error => {
                console.error("An error occurred during upload:", error);
                uploadStatus.textContent = `❌ Error: ${error.message}`;
            })
            .finally(() => {
                uploadBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            });
    });

    // --- Function to upload a single file and return a Promise ---
    function uploadFile(file) {
        return new Promise((resolve, reject) => {
            const formData = new FormData();
            formData.append('image', file);

            // 1. Upload to ImgBB
            fetch(`https://api.imgbb.com/1/upload?key=${imgbbApiKey}`, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 2. Save ImgBB URL to Firebase
                    const imageUrl = data.data.url;
                    imagesRef.push().set({
                        url: imageUrl,
                        caption: "A New Student Project"
                    });
                    resolve(data); // Resolve the promise on success
                } else {
                    throw new Error(data.error.message);
                }
            })
            .catch(error => {
                reject(error); // Reject the promise on failure
            });
        });
    }


    // --- DISPLAY & MANAGE LOGIC (no changes needed here) ---
    // 1. Add new image card when a child is added in Firebase
    imagesRef.on('child_added', function(snapshot) {
        const imageKey = snapshot.key;
        const imageData = snapshot.val();
        const imageCard = document.createElement('div');
        imageCard.classList.add('relative', 'group');
        imageCard.setAttribute('data-key', imageKey);
        imageCard.innerHTML = `
            <img src="${imageData.url}" class="rounded-lg shadow-md w-full h-48 object-cover">
            <button data-id="${imageKey}" class="delete-btn absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
        `;
        managementGallery.prepend(imageCard);
    });

    // 2. Remove image card when a child is removed from Firebase
    imagesRef.on('child_removed', function(snapshot) {
        const imageKey = snapshot.key;
        const cardToRemove = managementGallery.querySelector(`div[data-key="${imageKey}"]`);
        if (cardToRemove) {
            cardToRemove.remove();
        }
    });

    // 3. Handle delete button clicks
    managementGallery.addEventListener('click', function(event) {
        if (event.target.classList.contains('delete-btn')) {
            const imageKey = event.target.dataset.id;
            if (confirm('Are you sure you want to delete this image?')) {
                database.ref('images/' + imageKey).remove();
            }
        }
    });
</script>

</body>
</html>